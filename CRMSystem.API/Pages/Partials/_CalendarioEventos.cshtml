@model IEnumerable<CRMSystem.API.Models.EventoCalendario>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Calendario de Eventos
                </h5>
                <button type="button" 
                        class="btn btn-primary btn-sm"
                        hx-get="/api/eventos/nuevo"
                        hx-target="#modal-content"
                        hx-swap="innerHTML"
                        data-bs-toggle="modal"
                        data-bs-target="#eventModal">
                    <i class="fas fa-plus me-1"></i>
                    Nuevo Evento
                </button>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Próximos Eventos -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Próximos Eventos
                </h5>
            </div>
            <div class="card-body">
                @if (Model != null && Model.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var evento in Model.OrderBy(e => e.FechaInicio).Take(10))
                        {
                            <div class="list-group-item px-0">
                                <div class="d-flex align-items-start">
                                    <div class="me-3">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px; background-color: @evento.Color;">
                                            <i class="fas fa-@(evento.TipoEvento switch { "Reunión" => "users", "Llamada" => "phone", "Visita" => "map-marker-alt", "Capacitación" => "graduation-cap", _ => "calendar" }) text-white"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">@evento.Titulo</h6>
                                                <p class="mb-1 text-muted small">@evento.DescripcionEvento</p>
                                                <div class="d-flex align-items-center text-muted small">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    <span>@evento.FechaInicio.ToString("dd/MM/yyyy HH:mm")</span>
                                                    @if (!evento.TodoElDia)
                                                    {
                                                        <span class="mx-2">-</span>
                                                        <span>@evento.FechaFin.ToString("HH:mm")</span>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(evento.Ubicacion))
                                                {
                                                    <div class="text-muted small mt-1">
                                                        <i class="fas fa-map-marker-alt me-1"></i>
                                                        @evento.Ubicacion
                                                    </div>
                                                }
                                                @if (evento.Cliente != null)
                                                {
                                                    <div class="mt-1">
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-building me-1"></i>
                                                            @evento.Cliente.NombreEmpresa
                                                        </span>
                                                    </div>
                                                }
                                                else if (evento.Prospecto != null)
                                                {
                                                    <div class="mt-1">
                                                        <span class="badge bg-warning">
                                                            <i class="fas fa-user-plus me-1"></i>
                                                            @evento.Prospecto.NombreEmpresa
                                                        </span>
                                                    </div>
                                                }
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" 
                                                        class="btn btn-outline-primary"
                                                        hx-get="/api/eventos/@evento.Id"
                                                        hx-target="#modal-content"
                                                        hx-swap="innerHTML"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#eventModal"
                                                        title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-outline-success"
                                                        hx-get="/api/eventos/@evento.Id/editar"
                                                        hx-target="#modal-content"
                                                        hx-swap="innerHTML"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#eventModal"
                                                        title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-outline-danger"
                                                        hx-delete="/api/eventos/@evento.Id"
                                                        hx-confirm="¿Está seguro de eliminar este evento?"
                                                        hx-target="closest .list-group-item"
                                                        hx-swap="outerHTML swap:1s"
                                                        title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-calendar-times fa-3x mb-3"></i>
                        <p>No hay eventos programados</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        
        if (calendarEl) {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'Día',
                    list: 'Lista'
                },
                events: function(info, successCallback, failureCallback) {
                    // Cargar eventos desde la API
                    fetch('/api/eventos/calendario?start=' + info.startStr + '&end=' + info.endStr)
                        .then(response => response.json())
                        .then(data => {
                            const events = data.map(evento => ({
                                id: evento.id,
                                title: evento.titulo,
                                start: evento.fechaInicio,
                                end: evento.fechaFin,
                                allDay: evento.todoElDia,
                                backgroundColor: evento.color,
                                borderColor: evento.color,
                                extendedProps: {
                                    descripcion: evento.descripcionEvento,
                                    ubicacion: evento.ubicacion,
                                    tipoEvento: evento.tipoEvento
                                }
                            }));
                            successCallback(events);
                        })
                        .catch(error => {
                            console.error('Error al cargar eventos:', error);
                            failureCallback(error);
                        });
                },
                eventClick: function(info) {
                    // Cargar detalles del evento en modal usando HTMX
                    htmx.ajax('GET', '/api/eventos/' + info.event.id, {
                        target: '#modal-content',
                        swap: 'innerHTML'
                    }).then(() => {
                        var modal = new bootstrap.Modal(document.getElementById('eventModal'));
                        modal.show();
                    });
                },
                dateClick: function(info) {
                    // Crear nuevo evento en la fecha seleccionada
                    htmx.ajax('GET', '/api/eventos/nuevo?fecha=' + info.dateStr, {
                        target: '#modal-content',
                        swap: 'innerHTML'
                    }).then(() => {
                        var modal = new bootstrap.Modal(document.getElementById('eventModal'));
                        modal.show();
                    });
                },
                editable: true,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                weekends: true,
                eventDrop: function(info) {
                    // Actualizar evento cuando se arrastra a otra fecha
                    htmx.ajax('PUT', '/api/eventos/' + info.event.id + '/mover', {
                        values: {
                            fechaInicio: info.event.start.toISOString(),
                            fechaFin: info.event.end ? info.event.end.toISOString() : null
                        }
                    });
                },
                eventResize: function(info) {
                    // Actualizar evento cuando se redimensiona
                    htmx.ajax('PUT', '/api/eventos/' + info.event.id + '/redimensionar', {
                        values: {
                            fechaInicio: info.event.start.toISOString(),
                            fechaFin: info.event.end.toISOString()
                        }
                    });
                }
            });
            
            calendar.render();
            
            // Guardar referencia global para recargar después de crear/editar eventos
            window.crmCalendar = calendar;
        }
    });
    
    // Recargar calendario después de operaciones HTMX
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'calendario-section' && window.crmCalendar) {
            window.crmCalendar.refetchEvents();
        }
    });
</script>
}

